<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sell — RetailCloud (Demo)</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <header>
      <nav class="nav">
        <div class="logo">RetailCloud (Demo)</div>
        <div class="nav-links">
          <a href="index.html">Home</a>
          <a href="buy.html">Buy</a>
          <a href="sell.html" class="active">Sell</a>
          <a href="cart.html">Cart <span id="cart-badge" class="badge">0</span></a>
          <a href="orders.html">Orders</a>
          <button id="logout-btn" class="btn-link">Logout</button>
        </div>
      </nav>
    </header>

    <main class="container">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">Sell an Item</h2>
        <a href="index.html" class="btn small">← Back to Home</a>
      </div>
      <div class="sell-grid">
        <form id="sell-form" class="sell-form">
          <label>Product Name</label>
          <input id="p-name" required />
          <label>Price (USD)</label>
          <input id="p-price" type="number" min="0" step="0.01" required />
          <label>Image</label>
          <div style="display:flex; gap:8px; margin-bottom:10px;">
            <input id="p-image-url" placeholder="https://...jpg" style="flex:1;" />
            <label style="cursor:pointer; padding:8px 12px; background:#f0f0f0; border-radius:6px; font-size:0.9rem;">
              Or Upload
              <input id="p-image-file" type="file" accept="image/*" style="display:none;" />
            </label>
          </div>
          <div id="image-preview" style="margin-bottom:10px;"></div>
          <button class="btn" type="submit">Add Product</button>
        </form>

        <section id="my-products" class="grid"></section>
      </div>
    </main>

    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script>
      if (!auth_checkAuth()) window.location.href = 'login.html';
      renderCartBadge();
      document.getElementById('logout-btn').addEventListener('click', function(){ auth_logout(); });

      // render any stored user-added products with delete buttons
      async function renderMyProducts(){
        const container = document.getElementById('my-products');
        container.innerHTML = '';
        try {
          const res = await fetch('http://127.0.0.1:5000/api/user-products');
          const list = await res.json();
          list.forEach((p, idx) => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
              <img src="${p.image || 'https://via.placeholder.com/300'}" alt="${p.name}" />
              <div class="p-body">
                <h4>${p.name}</h4>
                <div class="price">$${parseFloat(p.price).toFixed(2)}</div>
                <button class="btn small delete-btn" data-idx="${idx}" style="margin-top:8px; background:#dc2626;">Delete</button>
              </div>
            `;
            container.appendChild(card);
          });
          // Attach delete listeners
          container.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async function(e){
              e.preventDefault();
              const idx = parseInt(this.dataset.idx);
              await deleteProduct(idx);
              renderMyProducts();
            });
          });
        } catch (err) {
          // Fallback to localStorage
          const list = JSON.parse(localStorage.getItem('userProducts') || '[]');
          list.forEach((p, idx) => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
              <img src="${p.image || 'https://via.placeholder.com/300'}" alt="${p.name}" />
              <div class="p-body">
                <h4>${p.name}</h4>
                <div class="price">$${parseFloat(p.price).toFixed(2)}</div>
                <button class="btn small delete-btn" data-idx="${idx}" style="margin-top:8px; background:#dc2626;">Delete</button>
              </div>
            `;
            container.appendChild(card);
          });
          // Attach delete listeners for localStorage fallback
          container.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async function(e){
              e.preventDefault();
              const idx = parseInt(this.dataset.idx);
              const list = JSON.parse(localStorage.getItem('userProducts') || '[]');
              list.splice(idx, 1);
              localStorage.setItem('userProducts', JSON.stringify(list));
              renderMyProducts();
            });
          });
        }
      }

      // Delete product from backend
      async function deleteProduct(idx){
        try {
          const res = await fetch('http://127.0.0.1:5000/api/user-products', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({index: idx})
          });
          const result = await res.json();
          if (result.success) {
            renderMyProducts();
          }
        } catch (err) {
          // Fallback to localStorage
          const list = JSON.parse(localStorage.getItem('userProducts') || '[]');
          list.splice(idx, 1);
          localStorage.setItem('userProducts', JSON.stringify(list));
          renderMyProducts();
        }
      }

      // Handle file upload for image
      document.getElementById('p-image-file').addEventListener('change', function(e){
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(evt){
            document.getElementById('p-image-url').value = evt.target.result;
            const preview = document.getElementById('image-preview');
            preview.innerHTML = `<img src="${evt.target.result}" style="width:100%; max-width:200px; border-radius:6px; margin-top:8px;" />`;
          };
          reader.readAsDataURL(file);
        }
      });

      document.getElementById('sell-form').addEventListener('submit', async function(e){
        e.preventDefault();
        const name = document.getElementById('p-name').value.trim();
        const price = document.getElementById('p-price').value;
        const image = document.getElementById('p-image-url').value.trim();
        if (!name || !price) return alert('Name and price required');
        try {
          const res = await fetch('http://127.0.0.1:5000/api/user-products', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, price, image})
          });
          const result = await res.json();
          if (result.success) {
            renderMyProducts();
            this.reset();
            document.getElementById('image-preview').innerHTML = '';
          }
        } catch (err) {
          // Fallback to localStorage
          const list = JSON.parse(localStorage.getItem('userProducts') || '[]');
          list.unshift({name, price, image});
          localStorage.setItem('userProducts', JSON.stringify(list));
          renderMyProducts();
          this.reset();
          document.getElementById('image-preview').innerHTML = '';
        }
      });

      renderMyProducts();
    </script>
  </body>
</html>
